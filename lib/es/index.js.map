{"version":3,"file":"index.js","sources":["process/helpers.js","process/register.js","process/index.js"],"sourcesContent":["export function isPromisable(arg){\r\n\treturn arg instanceof Promise || _.isFunction(arg && arg.then);\r\n}\r\n\r\nexport function asArray(arg) {\r\n\tif(_.isArray(arg))\r\n\t\treturn arg;\r\n\telse if(arg == null || arg === '')\r\n\t\treturn [];\r\n\telse\r\n\t\treturn [arg];\r\n}\r\n\r\nexport function race(...promises){\r\n\treturn Promise.race(promises);\r\n}\r\n\r\nexport function valueToPromise(arg){\r\n\tif(!isPromisable(arg)) {\r\n\t\tlet result = arg;\r\n\t\targ = arg == null || arg === '' ? Promise.resolve() : Promise.reject(result);\r\n\t}\r\n\treturn arg;\t\t\r\n}\r\n","\r\nexport default function (Process, context, name, opts) {\r\n\r\n\tcontext[name] = function(...args){\r\n\t\t\r\n\t\tlet process = new Process(context, name, _.extend({}, opts));\r\n\t\tlet concurrent = process.concurrencyCheck();\r\n\r\n\t\tif (concurrent)\r\n\t\t\treturn concurrent;\r\n\t\telse\r\n\t\t\treturn process.run(...args);\r\n\r\n\t};\r\n\r\n}\r\n","// import mix from '../../utils/mix/index.js';\r\n// import triggerMethodOn from '../../utils/trigger-method-on/index.js';\r\n// import camelCase from '../../utils/camel-case/index.js';\r\n// import result from '../../utils/better-result/index.js';\r\n\r\nimport { mix, triggerMethodOn, camelCase, betterResult as result } from 'bbmn-utils';\r\nimport { isPromisable, race, asArray, valueToPromise } from './helpers.js';\r\n\r\nimport register from './register.js';\r\n\r\n\r\nconst Process = mix({\r\n\tconstructor: function Process(context, name, opts){\r\n\t\tthis._initDefaults(name, context);\r\n\t\tthis._initCancelation();\r\n\t\tthis._mergeOptions(opts);\r\n\t},\r\n\r\n\r\n\t// initialize methods\r\n\r\n\t_initDefaults(name, context){\r\n\t\tif(name == null || name === '')\r\n\t\t\tthrow new Error('Process requires two arguments: name [string], context [object]. name missing');\r\n\t\t\r\n\t\tif(!_.isObject(context))\r\n\t\t\tthrow new Error('Process requires two arguments: name [string], context [object]. context is not an object');\r\n\r\n\t\tthis.cid = _.uniqueId('process');\r\n\t\tthis.name = name;\r\n\t\tthis.context = context;\r\n\t\tthis.errors = [];\r\n\t},\r\n\r\n\t_initCancelation(){\r\n\t\tthis.cancelPromise = new Promise((resolve, reject) => {\r\n\t\t\tthis.cancel = () => reject('cancel'); \r\n\t\t});\r\n\t},\r\n\t_mergeOptions(opts = {}){\r\n\t\tlet options = _.omit(opts, 'cid', 'name', 'context', 'cancelPromise', 'cancel', 'errors');\r\n\t\t_(options).each((value, key) => this[key] = value);\r\n\t},\r\n\r\n\t\r\n\tconcurrencyCheck(){\r\n\r\n\t\tlet previous = this.getProcessFromContext();\r\n\t\t//console.log(previous, this.context);\r\n\t\tif(!previous) return;\r\n\t\r\n\t\tlet concurrent = this.concurrent;\t\r\n\t\t\r\n\t\tif (concurrent === false) {\r\n\t\r\n\t\t\tthis.cancel();\r\n\t\r\n\t\t} else if (concurrent == 'first') {\r\n\t\r\n\t\t\treturn previous.promise;\r\n\t\r\n\t\t} else if (concurrent == 'last') {\r\n\t\r\n\t\t\tprevious.cancel();\r\n\t\r\n\t\t}\t\t\r\n\t},\r\n\r\n\r\n\t// life cycle methods\t\r\n\r\n\trun(...args){\r\n\t\tthis.updateProcessInContext(this);\r\n\t\tthis.args = args || [];\r\n\t\tthis.promise = this._createLifeCyclePromise();\r\n\t\treturn this.promise;\r\n\t},\r\n\r\n\r\n\t_createLifeCyclePromise(){\r\n\r\n\r\n\t\treturn this._notCanceled()\r\n\t\t\t.then(() => this._begin())\r\n\t\t\t.then(() => this._beforeStart())\r\n\t\t\t.then(() => this._canBeStarted())\r\n\t\t\t.then(() => this._waitOtherPromises())\r\n\t\t\t.then(() => {\r\n\t\t\t\tthis.triggerComplete();\r\n\t\t\t\treturn Promise.resolve();\r\n\t\t\t})\r\n\t\t\t.catch(error => {\r\n\t\t\t\tthis.triggerError(error);\r\n\t\t\t\tlet jsError;\r\n\t\t\t\tif(error instanceof Error) {\r\n\t\t\t\t\tthrow error;\r\n\t\t\t\t} else if ((jsError = this.getJsError())) {\r\n\t\t\t\t\tthrow jsError;\r\n\t\t\t\t} else {\r\n\t\t\t\t\treturn Promise.reject(this);\r\n\t\t\t\t}\r\n\t\t\t});\t\t\r\n\t},\r\n\r\n\r\n\r\n\r\n\t_notCanceled() {\r\n\t\treturn this._cancelationRace(Promise.resolve());\r\n\t},\r\n\t_begin(){\r\n\t\treturn this._getHookResultAsPromise('begin');\r\n\t},\r\n\t_beforeStart(){\r\n\t\treturn this._getHookResultAsPromise('before');\r\n\t},\r\n\t_canBeStarted(){\r\n\t\tlet contextMethod = 'can:not:' + this.name;\r\n\t\tlet promise = this.invokeOnContext(contextMethod);\r\n\t\tif(!isPromisable(promise)) {\r\n\t\t\tpromise = (promise == null || promise === '') \r\n\t\t\t\t? Promise.resolve()\r\n\t\t\t\t: Promise.reject(promise);\r\n\t\t}\r\n\t\treturn this._cancelationRace(promise);\r\n\t},\r\n\t_waitOtherPromises(){\r\n\t\tlet contextMethod = `get:${this.name}:promises`;\r\n\t\t\r\n\t\tlet promises = asArray(this.invokeOnContext(contextMethod));\r\n\r\n\t\treturn this._cancelationRace(Promise.all(promises));\r\n\t},\r\n\r\n\t_getHookResultAsPromise(hookName){\r\n\t\tlet procMethod = camelCase('on:' + hookName);\r\n\t\tlet procHook = _.isFunction(this[procMethod]) && this[procMethod](this.context, ...this.args) || undefined;\r\n\t\tlet result = valueToPromise(procHook).then(() => {\r\n\t\t\tlet cntxHook = this.triggerOnContext(hookName);\r\n\t\t\treturn valueToPromise(cntxHook);\r\n\t\t});\r\n\r\n\t\treturn this._cancelationRace(result);\r\n\r\n\t},\r\n\r\n\t// trigger methods\r\n\r\n\ttriggerComplete() { \r\n\r\n\t\tthis.updateProcessInContext(null);\r\n\r\n\t\tif (_.isFunction(this.onComplete))\r\n\t\t\tthis.onComplete(this.context, ...this.args);\r\n\r\n\t\tthis.triggerOnContext();\r\n\r\n\t\tthis.triggerEnd();\r\n\t\t\r\n\t\r\n\t},\r\n\ttriggerError(errors){\r\n\r\n\r\n\t\tthis.updateProcessInContext(null);\t\t\r\n\r\n\t\tif(!_.isArray(errors))\r\n\t\t\terrors = [errors];\r\n\r\n\t\tthis.errors.push(...errors);\r\n\r\n\t\t\r\n\t\tif (_.isFunction(this.onError))\r\n\t\t\tthis.onError(this.context, ...this.errors);\r\n\t\t\r\n\t\tthis.triggerOnContext('error', ...this.errors);\r\n\t\t\r\n\t\tthis.triggerEnd();\r\n\r\n\t\t\r\n\t},\r\n\ttriggerEnd(){\r\n\t\tthis.triggerOnContext('end');\r\n\t},\r\n\r\n\r\n\r\n\t// helpers methods\r\n\r\n\tgetJsError(context){\r\n\t\t!context && (context = this);\r\n\t\tif(context != this && (!_.isObject(context) || !_.isArray(context.errors)))\r\n\t\t\treturn;\r\n\r\n\t\treturn _(context.errors).filter(f => f instanceof Error)[0];\r\n\t},\t\r\n\r\n\t_cancelationRace(promise){\r\n\t\treturn race(this.cancelPromise, promise);\r\n\t},\r\n\r\n\r\n\tgetContextProcessKey(){\r\n\t\treturn camelCase(`_process:${this.name}:executing`);\r\n\t},\r\n\tgetProcessFromContext(){\r\n\t\tlet key = this.getContextProcessKey();\r\n\t\treturn this.context[key];\r\n\t},\r\n\tupdateProcessInContext(process){\r\n\t\tlet key = this.getContextProcessKey();\t\t\r\n\t\tthis.context[key] = process;\r\n\t},\r\n\r\n\r\n\r\n\ttriggerOnContext (eventName) {\r\n\t\r\n\t\tlet context = this.context; \r\n\t\tif(!_.isFunction(context.trigger))\r\n\t\t\treturn;\r\n\t\t\r\n\t\tlet event = (eventName ? eventName + ':' : '') + this.name;\r\n\t\t\r\n\t\treturn triggerMethodOn(context, event, this, ...this.args);\r\n\t\r\n\t},\r\n\r\n\tinvokeOnContext(methodName)\r\n\t{\r\n\t\tlet method = camelCase(methodName);\r\n\t\tlet context = this.context;\r\n\t\tlet args = this.args;\r\n\t\treturn result(context, method, { args });\r\n\r\n\t}\r\n\r\n}).class;\r\n\r\n\r\nProcess.register = function(context, name, opts) {\r\n\treturn register(this, context, name, opts);\r\n};\r\n\r\nexport default Process;\r\n"],"names":["isPromisable","arg","Promise","_","isFunction","then","asArray","isArray","race","promises","valueToPromise","result","resolve","reject","Process","context","name","opts","process","extend","concurrent","concurrencyCheck","run","mix","_initDefaults","_initCancelation","_mergeOptions","Error","isObject","cid","uniqueId","errors","cancelPromise","cancel","options","omit","each","value","key","previous","getProcessFromContext","promise","updateProcessInContext","args","_createLifeCyclePromise","_notCanceled","_begin","_beforeStart","_canBeStarted","_waitOtherPromises","triggerComplete","catch","triggerError","error","jsError","getJsError","_cancelationRace","_getHookResultAsPromise","contextMethod","invokeOnContext","all","hookName","procMethod","camelCase","procHook","undefined","cntxHook","triggerOnContext","onComplete","triggerEnd","push","onError","filter","f","getContextProcessKey","eventName","trigger","event","triggerMethodOn","methodName","method","class","register"],"mappings":"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"}